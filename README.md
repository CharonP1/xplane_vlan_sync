# X-Plane 多机 TSN 同步演示系统

## 项目简介
本项目基于改造后的 XPC (XPlane Connect) 协议，实现了一台主机（Sender）控制多台从机（Receiver）的飞行姿态同步。
本系统专用于演示 TSN (时间敏感网络) 与 普通以太网 在高负载干扰环境下的性能差异。主机通过构造带有 IEEE 802.1Q VLAN 标签和 PCP 优先级的原始以太网帧，分别向两条链路发送数据。

## 快速开始指南

### 阶段 1：环境准备 (所有机器)
在主机和两台从机上均需执行以下命令安装依赖：
```bash
make install-deps
```
### 阶段 2：网络配置 (按角色执行)

#### A.配置主机 (在 Nd-30 上执行) 
```bash
make setup-host
```

#### B.配置TSN从机 (在 Nd-40 上执行) 
```bash
make setup-slave-tsn
```

#### C.配置普通从机 (在 Nd-10 上执行) 
```bash
make setup-slave-std
```

### 阶段 3：启动同步
#### 步骤 1：启动接收端 (从机)
-在 Nd-40 (TSN) 和 Nd-10 (普通) 上分别启动 X-Plane。

-加载任意飞机（建议使用 Cessna 172），确保飞机停在机场跑道上。

-注意：从机不需要运行任何额外的接收脚本或插件配置，只要 VLAN 网络配置正确（阶段 2），Linux 内核会自动将收到的 UDP 数据包转发给 X-Plane。
#### 步骤 2：启动发送端 (从机)
-在 Nd-30 上启动 X-Plane 并开始飞行。

-打开终端，进入项目目录，编译并运行发送程序：
```bash
make run-sender
```

## 网络拓扑与角色定义

实验包含三台端系统和多台交换机，角色分配如下：

### 1. 主机 (Sender)
- 设备: Nd-54-43-41-00-00-30
- MAC: `54:43:41:00:00:30` (物理被修改)
- IP: `192.168.2.30`
- 功能: 采集 X-Plane 飞行数据，封装为 VLAN 帧并广播。
- 连接: 连接至 TSN 交换机 Sw-02 (Port 2)。

### 2. TSN 从机 (Receiver 1)
- 设备: Nd-54-43-41-00-00-40
- MAC: `54:43:41:00:00:40`
- IP: `192.168.2.40`
- 链路特征: 全程 TSN 交换机连接，接收 高优先级 (PCP=5) 数据帧。
- 连接: 位于 Sw-06 下游 (Port 8)。

### 3. 普通以太网从机 (Receiver 2)
- 设备: Nd-54-43-41-00-00-10
- MAC: `54:43:41:00:00:10`
- IP: `192.168.2.10`
- 链路特征: 经过普通以太网交换机，接收 低优先级 (PCP=0) 数据帧，无 QoS 保障。
- 连接: 位于普通交换机 A 下游。

---


## 常见问题排查
### Q1: 从机无法接收数据，飞机不动？

检查交换机端口配置：连接主机的端口、级联口、连接从机的端口是否都已配置为 Trunk 且 Allowed VLAN 100。

检查交换机出口规则：连接从机的端口必须配置为 Untag PVID 或 保留 Tag (取决于是否使用了子接口，本项目脚本使用了子接口，故交换机应保留 Tag)。

在从机上运行抓包命令诊断：

```Bash
make capture-vlan
```
如果能抓到包但 X-Plane 不动，检查防火墙是否放行 UDP 49009。


### Q2: 画面不同步或抖动？

确保 X-Plane 的设置 -> 网络 -> 数据输出 (Data Output) 中，不要勾选任何“发送到网络”的选项，防止从机反向发送数据干扰主机。

确保两台从机没有运行其他占用 UDP 49009 端口的程序。

### Q3: 编译失败？

确保已执行 make install-deps 安装了 libpcap-dev。
